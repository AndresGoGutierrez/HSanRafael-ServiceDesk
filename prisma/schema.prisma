generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  email           String       @unique
  areaId          String?      @db.Uuid
  createdAt       DateTime     @default(now())
  isActive        Boolean      @default(true)
  password        String
  role            String
  attachments     Attachment[] @relation("AttachmentUploader")
  auditLogs       AuditTrail[] @relation("AuditActor")
  comments        Comment[]    @relation("CommentAuthor")
  assignedTickets Ticket[]     @relation("AssignedTickets")
  tickets         Ticket[]     @relation("UserTickets")
  area            Area?        @relation("UserArea", fields: [areaId], references: [id])

  @@index([email])
  @@index([areaId])
}

model Area {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String   @unique
  createdAt            DateTime @default(now())
  description          String?
  isActive             Boolean  @default(true)
  slaResolutionMinutes Int?
  slaResponseMinutes   Int?
  workflowConfig       Json?
  tickets              Ticket[] @relation("AreaTickets")
  users                User[]   @relation("UserArea")

  @@index([name])
}

model Ticket {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title             String
  status            String
  priority          String
  areaId            String       @db.Uuid
  assigneeId        String?      @db.Uuid
  closedAt          DateTime?
  createdAt         DateTime     @default(now())
  description       String?
  firstResponseAt   DateTime?
  requesterId       String       @db.Uuid
  resolutionSummary String?
  resolvedAt        DateTime?
  slaBreached       Boolean      @default(false)
  slaTargetAt       DateTime?
  updatedAt         DateTime     @updatedAt
  attachments       Attachment[] @relation("TicketAttachments")
  auditLogs         AuditTrail[] @relation("TicketAudit")
  comments          Comment[]    @relation("TicketComments")
  area              Area         @relation("AreaTickets", fields: [areaId], references: [id])
  assignee          User?        @relation("AssignedTickets", fields: [assigneeId], references: [id])
  requester         User         @relation("UserTickets", fields: [requesterId], references: [id])

  @@index([status])
  @@index([priority])
  @@index([requesterId])
  @@index([assigneeId])
  @@index([areaId])
  @@index([slaTargetAt])
  @@index([createdAt])
}

model Comment {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId   String   @db.Uuid
  authorId   String   @db.Uuid
  body       String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  author     User     @relation("CommentAuthor", fields: [authorId], references: [id])
  ticket     Ticket   @relation("TicketComments", fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

model Attachment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId    String   @db.Uuid
  uploaderId  String   @db.Uuid
  filename    String
  contentType String
  size        Int
  url         String
  createdAt   DateTime @default(now())
  ticket      Ticket   @relation("TicketAttachments", fields: [ticketId], references: [id], onDelete: Cascade)
  uploader    User     @relation("AttachmentUploader", fields: [uploaderId], references: [id])

  @@index([ticketId])
  @@index([uploaderId])
}

model AuditTrail {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId   String?  @db.Uuid
  actorId    String   @db.Uuid
  action     String
  entityType String
  entityId   String   @db.Uuid
  changes    Json?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  occurredAt DateTime @default(now())
  actor      User     @relation("AuditActor", fields: [actorId], references: [id])
  ticket     Ticket?  @relation("TicketAudit", fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([actorId])
  @@index([action])
  @@index([entityType])
  @@index([occurredAt])
}
